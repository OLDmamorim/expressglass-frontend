<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
  <title>Portal de Agendamento - Expressglass</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">

  <!-- >>>>>> APENAS PRINT (não afeta ecrã) <<<<<< -->
  <style>
    /* Secções de impressão começam ocultas no ecrã */
    .print-unscheduled-section,
    .print-today-section,
    .print-tomorrow-section { display: none; }

    /* Tabelas de impressão (base) */
    .print-unscheduled-table,
    .print-today-table,
    .print-tomorrow-table { width: 100%; border-collapse: collapse; }
    .print-unscheduled-table th, .print-unscheduled-table td,
    .print-today-table th,        .print-today-table td,
    .print-tomorrow-table th,     .print-tomorrow-table td {
      border: 1px solid #111; padding: 4px 6px; font-size: 12px; vertical-align: top;
    }

    @media print {
      .no-print { display: none !important; }
      .print-unscheduled-section,
      .print-today-section,
      .print-tomorrow-section { display: block; }

      .print-break-before { break-before: page; page-break-before: always; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      tr, th, td { break-inside: avoid; page-break-inside: avoid; }

      .print-today-table,
      .print-tomorrow-table{
        width:100% !important; border-collapse:collapse !important; table-layout:fixed !important;
      }

      .print-today-table th:nth-child(1),    .print-today-table td:nth-child(1),
      .print-tomorrow-table th:nth-child(1), .print-tomorrow-table td:nth-child(1){ width: 8%; }  /* Período */
      .print-today-table th:nth-child(2),    .print-today-table td:nth-child(2),
      .print-tomorrow-table th:nth-child(2), .print-tomorrow-table td:nth-child(2){ width:12%; }  /* Matrícula */
      .print-today-table th:nth-child(3),    .print-today-table td:nth-child(3),
      .print-tomorrow-table th:nth-child(3), .print-tomorrow-table td:nth-child(3){ width:16%; }  /* Carro */
      .print-today-table th:nth-child(4),    .print-today-table td:nth-child(4),
      .print-tomorrow-table th:nth-child(4), .print-tomorrow-table td:nth-child(4){ width:10%; }  /* Serviço */
      .print-today-table th:nth-child(5),    .print-today-table td:nth-child(5),
      .print-tomorrow-table th:nth-child(5), .print-tomorrow-table td:nth-child(5){ width:14%; }  /* Localidade */
      .print-today-table th:nth-child(6),    .print-today-table td:nth-child(6),
      .print-tomorrow-table th:nth-child(6), .print-tomorrow-table td:nth-child(6){ width: 8%; }  /* Estado */
      .print-today-table th:nth-child(7),    .print-today-table td:nth-child(7),
      .print-tomorrow-table th:nth-child(7), .print-tomorrow-table td:nth-child(7){ width:24%; }  /* Observações */
      .print-today-table th:nth-child(8),    .print-tomorrow-table td:nth-child(8),
      .print-tomorrow-table td:nth-child(8){ width:8%; }   /* Outros */

      .print-today-table th, .print-today-table td,
      .print-tomorrow-table th, .print-tomorrow-table td{
        border:1px solid #000 !important; padding:4px 6px !important; font-size:12px !important;
        vertical-align:top !important; white-space:normal !important;
      }

      .print-today-table thead, .print-tomorrow-table thead{ display: table-header-group !important; }
    }

    /* ===== ECRÃ (NÃO PRINT): Ajustes de colunas na tabela principal ===== */
    .services-table { table-layout: fixed; width: 100%; }
    .services-table th, .services-table td{ overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* Data */        .services-table th:nth-child(1), .services-table td:nth-child(1){ width: 8%; }
    /* Período */     .services-table th:nth-child(2), .services-table td:nth-child(2){ width: 9%; }
    /* Matrícula */   .services-table th:nth-child(3), .services-table td:nth-child(3){ width: 10%; }
    /* Carro */       .services-table th:nth-child(4), .services-table td:nth-child(4){ width: 16%; }
    /* Serviço */     .services-table th:nth-child(5), .services-table td:nth-child(5){ width: 10%; }
    /* Localidade */  .services-table th:nth-child(6), .services-table td:nth-child(6){ width: 13%; }
    /* Observações */ .services-table th:nth-child(7), .services-table td:nth-child(7){ width: 24%; }
    /* Estado */      .services-table th:nth-child(8), .services-table td:nth-child(8){ width: 8%; }
    /* Dias */        .services-table th:nth-child(9), .services-table td:nth-child(9){ width: 6%; }
    .table-wrapper{ overflow-x:auto; }
    @media (max-width:1100px){ .services-table{ min-width:1100px; } }

    /* ===== MOBILE CARDS — cor pela LOCALIDADE; texto branco com contorno ===== */
    @media (max-width: 768px){
      #mobileDayList{ display: grid; gap: 16px; padding: 8px 16px; }

      .m-card{
        position: relative;
        border-radius: 22px;
        padding: 16px;
        background: linear-gradient(180deg, var(--c1, #1e88e5) 0%, var(--c2, #1565c0) 100%);
        box-shadow: 0 8px 24px rgba(0,0,0,.18);
        color: #fff;
      }
      /* texto branco + leve sombra para legibilidade */
      .m-card, .m-card *{
        color:#fff !important;
        text-shadow:
          0 1px 2px rgba(0,0,0,.55),
          0 0 2px rgba(0,0,0,.35);
      }

      .m-title{
        display: flex; align-items: center; gap: 8px;
        font-weight: 800; font-size: 20px; letter-spacing: .2px;
      }
      .m-chips{ display:flex; gap:10px; margin:12px 0 8px; flex-wrap:wrap; }

      .m-chip{
        background: transparent;
        border: 1px solid rgba(255,255,255,.45);
        border-radius: 999px;
        padding: 6px 10px;
        font-weight: 700; font-size: 14px; line-height: 1;
      }

      .m-info{ margin-top: 6px; font-size: 15px; font-weight: 600; opacity: .95; }

      #mobileDayList .m-status,
      #mobileDayList .status,
      #mobileDayList .m-divider{ display:none !important; }
    }
  </style>
  <!-- /PRINT -->
</head>
<body>
  <div class="page">
    <!-- ... todo o teu HTML igual ao que já tinhas (header, nav-bar, tabelas, formulários, etc.) ... -->

    <!-- (mantive tudo igual ao ficheiro que enviaste, até ao penúltimo script) -->

  </div>

  <script src="api.js"></script>
  <script src="script.js"></script>
  <script src="horizontal-services-layout.js"></script>
  <script src="horizontal-layout-final.js"></script>
  <script src="expressglass-sabado-final.js"></script>
  <script src="expressglass-sabado-automatico-final.js"></script>
  <script src="expressglass-sabado-definitivo.js"></script>

  <!-- >>>>>> SCRIPT DE IMPRESSÃO (igual ao que já tinhas) <<<<<< -->
  <script>
   /* ... esse script não mexi ... */
  </script>

  <!-- ===== MOBILE CARD SKIN — FIX (corrigido) ===== -->
  <script>
  (function(){
    const LIST = document.getElementById('mobileDayList');
    if(!LIST) return;

    const clamp=n=>Math.max(0,Math.min(255,Math.round(n)));
    const hx=n=>n.toString(16).padStart(2,'0');
    const rgbToHex=({r,g,b})=>('#'+hx(clamp(r))+hx(clamp(g))+hx(clamp(b)));
    function parseColor(str){
      if(!str) return null; str=String(str).trim();
      if(str.startsWith('#')){
        if(str.length===4) return {r:parseInt(str[1]+str[1],16),g:parseInt(str[2]+str[2],16),b:parseInt(str[3]+str[3],16)};
        if(str.length>=7)  return {r:parseInt(str.slice(1,3),16), g:parseInt(str.slice(3,5),16), b:parseInt(str.slice(5,7),16)};
      }
      const m=str.match(/rgba?\(\s*(\d+)[,\s]+(\d+)[,\s]+(\d+)/i);
      return m?{r:+m[1],g:+m[2],b:+m[3]}:null;
    }
    const lighten=(rgb,a)=>({r:rgb.r+(255-rgb.r)*a,g:rgb.g+(255-rgb.g)*a,b:rgb.b+(255-rgb.b)*a});
    const darken =(rgb,a)=>({r:rgb.r*(1-a),      g:rgb.g*(1-a),      b:rgb.b*(1-a)      });
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

    function getBaseColor(node, data){
      const comp = getComputedStyle(node);
      const bg = comp.backgroundColor || node.style.backgroundColor;
      if(bg && bg!=='rgba(0, 0, 0, 0)') return bg;
      if(data.locality && window.LOCALITY_COLORS?.[data.locality]) return window.LOCALITY_COLORS[data.locality];
      return '#1e88e5';
    }

    function buildCard(data, baseColor){
      const el = document.createElement('article');
      el.className = 'm-card';
      const rgb = parseColor(baseColor) || parseColor('#1e88e5');
      const c1  = rgbToHex(lighten(rgb, 0.08));
      const c2  = rgbToHex(darken (rgb, 0.15));
      el.style.setProperty('--c1', c1);
      el.style.setProperty('--c2', c2);
      el.innerHTML = `
        <div class="m-title">${esc(data.plate||'')}
          ${data.service ? ' | '+esc(data.service) : ''} 
          ${data.car ? ' | '+esc(data.car) : ''}</div>
        <div class="m-chips">
          ${data.period ? `<span class="m-chip">${esc(data.period)}</span>` : ''}
        </div>
        ${data.subline ? `<div class="m-info">${esc(data.subline)}</div>` : ''}
      `;
      return el;
    }

    function isRealItem(node){
      return node instanceof HTMLElement &&
             (node.querySelector('.appt-header') || node.querySelector('.appt-sub'));
    }

    function skinItem(node){
      if(!isRealItem(node)) return;
      if(node.classList.contains('m-card')) return;
      if(node.dataset.skinned === '1') return;

      const header = node.querySelector('.appt-header')?.textContent || '';
      const subTxt = node.querySelector('.appt-sub')?.textContent || '';

      let period='', plate='', service='', car='';
      const [p, restRaw] = header.split(' - ');
      if(p) period = p.trim();
      if(restRaw){
        const parts = restRaw.split('|').map(s=>s.trim());
        plate   = parts[0] || '';
        service = parts[1] || '';
        car     = parts[2] || '';
      }

      let locality='', subline='';
      if(subTxt){
        const parts = subTxt.split('|');
        locality = (parts[0] || '').trim();
        subline  = subTxt.trim();
      }

      const data = { period, plate, service, car, locality, subline };
      const baseColor = getBaseColor(node, data);
      const card = buildCard(data, baseColor);

      node.dataset.skinned = '1';
      node.replaceWith(card);
    }

    function apply(){
      Array.from(LIST.children).forEach(skinItem);
      LIST.querySelectorAll('.appt-header, .appt-sub').forEach(el=>{
        const item = el.closest('.appt-item') || el.parentElement;
        if(item) skinItem(item);
      });
    }

    let timer, raf;
    function applySoon(){
      if(raf) cancelAnimationFrame(raf);
      if(timer) clearTimeout(timer);
      raf = requestAnimationFrame(()=> { timer = setTimeout(apply, 30); });
    }

    window.addEventListener('load', applySoon);
    new MutationObserver(applySoon).observe(LIST, {childList:true, subtree:true});
    ['prevDay','nextDay','todayDay','prevWeek','nextWeek','todayWeek']
      .forEach(id => document.getElementById(id)?.addEventListener('click', applySoon));
    setTimeout(applySoon, 120);
    setTimeout(applySoon, 400);
  })();
  </script>
</body>
</html>